{% extends "layout.html" %}

{% block content %}
<div class="row">
    <!-- Config Panel -->
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üõ†Ô∏è Configurar Roteiro</h5>
            </div>
            <div class="card-body">
                <form id="searchForm">
                    <div class="row g-2 mb-3">
                        <div class="col">
                            <label class="form-label">Adultos</label>
                            <input type="number" class="form-control" name="pax_adults" value="1" min="1">
                        </div>
                        <div class="col">
                            <label class="form-label">Crian√ßas</label>
                            <input type="number" class="form-control" name="pax_children" value="0" min="0">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Data In√≠cio</label>
                        <input type="date" class="form-control" name="start_date" id="startDate" required>
                    </div>

                     <div class="mb-3">
                        <label class="form-label">Fonte de Dados</label>
                        <select class="form-select" id="dataProvider" name="provider">
                            <option value="Mock Data" selected>Mocks</option>
                            <option value="Amadeus API">Amadeus</option>
                            <option value="Google Flights">Foogle Fly (Google Flights)</option>
                            <option value="Kayak">Kakak (Kayak)</option>
                        </select>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="searchHotels" name="search_hotels">
                            <label class="form-check-label" for="searchHotels">üè® Buscar Hot√©is (Beta)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="isRoundTrip" name="is_round_trip">
                            <label class="form-check-label" for="isRoundTrip">Ida e Volta</label>
                        </div>
                        <div id="returnDateDiv" class="d-none">
                            <label class="form-label">Data de Retorno</label>
                            <input type="date" class="form-control" name="return_date" id="returnDate">
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useMockData" name="use_mock_data">
                            <label class="form-check-label" for="useMockData">Usar Dados Mock (Teste)</label>
                        </div>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="searchHotels" name="search_hotels">
                            <label class="form-check-label" for="searchHotels">üè® Buscar Hot√©is (Beta)</label>
                        </div>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="searchCars" name="search_cars">
                            <label class="form-check-label" for="searchCars">üöó Alugar Carro</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Origens (sep. v√≠rgula)</label>
                        <input type="text" class="form-control" name="origin_cities" value="S√£o Paulo" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Destinos (sep. v√≠rgula)</label>
                        <input type="text" class="form-control" name="destination_cities" value="Miami" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cidades Obrigat√≥rias</label>
                        <input type="text" class="form-control" name="mandatory_cities" placeholder="Opcional">
                    </div>

                    <hr>
                    <label class="form-label fw-bold">Prioridade</label>
                    <div class="mb-3">
                        <label class="form-label small">Custo vs Tempo</label>
                        <input type="range" class="form-range" id="weightRange" min="0" max="100" value="70">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>Mais R√°pido</span>
                            <span>Mais Barato</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="btnSubmit">
                        üöÄ Otimizar Viagem
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="col-md-8">
        <!-- Initial State -->
        <div id="welcomeState" class="text-center p-5 bg-white rounded shadow-sm">
            <h2 class="text-primary">Bem-vindo, {{ user.full_name or user.email }}!</h2>
            <p class="lead">Configure sua viagem ao lado para encontrar o melhor roteiro.</p>
            <div class="mt-4">
                <h5>Seus √öltimos Roteiros</h5>
                <div id="historyList" class="list-group list-group-flush text-start mt-3">
                    <p class="text-muted text-center">Carregando hist√≥rico...</p>
                </div>
                <!-- Right column removed: using only search history as source of detail -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center p-5 d-none">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 lead">Analisando milhares de voos e conex√µes...</p>
        </div>

        <!-- Results Container (Injected via JS) -->
        <div id="resultsContainer" class="d-none"></div>
    </div>
</div>

<!-- Itinerary Modal -->
<div class="modal fade" id="itineraryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Itiner√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="itineraryModalBody">
                <div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    // Set default date
    const today = new Date();
    today.setDate(today.getDate() + 30);
    document.getElementById('startDate').valueAsDate = today;

    // Load History (search history) and saved itineraries separately to avoid duplication
    async function loadHistory() {
        const token = getCookie('access_token');
        const list = document.getElementById('historyList');
        list.innerHTML = '';

        try {
            // Fetch history and itineraries (to enrich with custo/tempo)
            const [resHist, resItins] = await Promise.all([
                fetch('/users/history', { headers: { 'Authorization': 'Bearer ' + token } }),
                fetch('/api/itineraries', { headers: { 'Authorization': 'Bearer ' + token } })
            ]);

            if (!resHist.ok) {
                list.innerHTML = '<p class="text-center text-muted">Falha ao carregar hist√≥rico.</p>';
                return;
            }

            const history = await resHist.json();
            const itineraries = resItins.ok ? await resItins.json() : [];
            const itinBySearchId = {};
            itineraries.forEach(it => { if (it.search_id) itinBySearchId[it.search_id] = it; });

            if (!history || history.length === 0) {
                list.innerHTML = '<p class="text-center text-muted">Nenhuma busca recente.</p>';
                return;
            }

            const fmtDuration = (min) => {
                if (!min && min !== 0) return '-';
                const h = Math.floor(min / 60);
                const m = min % 60;
                return `${h}h ${m}m`;
            };

            history.forEach(h => {
                const it = itinBySearchId[h.id];
                const totalCost = it && typeof it.total_cost === 'number' ? `R$ ${it.total_cost.toFixed(2)}` : '‚Äî';
                const totalTime = it && typeof it.total_duration === 'number' ? fmtDuration(it.total_duration) : '‚Äî';

                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.href = '#';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${h.origin} ‚ûù ${h.destinations}</h6>
                            <small class="text-muted">Partida: ${new Date(h.start_date).toLocaleDateString()}</small>
                        </div>
                        <div class="text-end">
                            <div class="small"><span class="me-1">üí∞</span><strong>${totalCost}</strong></div>
                            <div class="small text-muted"><span class="me-1">‚è±Ô∏è</span>${totalTime}</div>
                        </div>
                    </div>
                `;
                item.addEventListener('click', (ev) => { ev.preventDefault(); if (h.id) showItineraryModal(h.id); });
                list.appendChild(item);
            });
        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-center text-muted">Erro ao carregar hist√≥rico.</p>';
        }
    }
    loadHistory();

    // Toggle Return Date
    const chkRound = document.getElementById('isRoundTrip');
    chkRound.addEventListener('change', () => {
        const div = document.getElementById('returnDateDiv');
        const input = document.getElementById('returnDate');
        if (chkRound.checked) {
            div.classList.remove('d-none');
            input.required = true;
        } else {
            div.classList.add('d-none');
            input.required = false;
        }
    });

    // Form Submit
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // UI Transition
        document.getElementById('welcomeState').classList.add('d-none');
        document.getElementById('resultsContainer').classList.add('d-none');
        document.getElementById('loadingState').classList.remove('d-none');
        document.getElementById('btnSubmit').disabled = true;

        const formData = new FormData(e.target);

        // Prepare Request
        const weightCost = document.getElementById('weightRange').value / 100;

        const reqBody = {
            origin_cities: formData.get('origin_cities').split(',').map(s => s.trim()),
            destination_cities: formData.get('destination_cities').split(',').map(s => s.trim()),
            mandatory_cities: formData.get('mandatory_cities') ? formData.get('mandatory_cities').split(',').map(s => s.trim()) : [],
            pax_adults: parseInt(formData.get('pax_adults')),
            pax_children: parseInt(formData.get('pax_children')),
            start_date: formData.get('start_date') + "T00:00:00",
            weight_cost: weightCost,
            weight_time: 1 - weightCost,
            weight_cost: weightCost,
            weight_time: 1 - weightCost,
            is_round_trip: chkRound.checked,
            provider: document.getElementById('dataProvider').value,
            search_hotels: document.getElementById('searchHotels').checked
            use_mock_data: document.getElementById('useMockData').checked,
            search_hotels: document.getElementById('searchHotels').checked,
            search_cars: document.getElementById('searchCars').checked
        };

        if (chkRound.checked && formData.get('return_date')) {
            reqBody.return_date = formData.get('return_date') + "T00:00:00";
        }

        try {
            const res = await fetch('/api/solve', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getCookie('access_token')
                },
                body: JSON.stringify(reqBody)
            });

            if (res.ok) {
                const result = await res.json();
                renderResults(result);
            } else if (res.status === 401) {
                alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
                window.location.href = "/login";
            } else {
                alert("Erro ao processar: " + res.statusText);
            }
        } catch (err) {
            console.error(err);
            alert("Erro de conex√£o.");
        } finally {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('btnSubmit').disabled = false;
        }
    });

    function renderResults(data) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';
        container.classList.remove('d-none');

        if (data.status !== 'Optimal') {
            let msg = '';
            if (data.status === 'Infeasible') {
                msg = `<div class="alert alert-warning">‚ö†Ô∏è <strong>Aviso:</strong> N√£o foi poss√≠vel identificar uma rota v√°lida com as restri√ß√µes informadas. Tente flexibilizar as datas ou cidades.</div>`;
            } else {
                msg = `<div class="alert alert-warning">‚ö†Ô∏è <strong>Aviso:</strong> Otimiza√ß√£o incompleta (Status: ${data.status}). Verifique os dados.</div>`;
            }

            if (data.warning_message) {
                msg += `<div class="alert alert-info">üí° <strong>Sugest√£o:</strong> ${data.warning_message}</div>`;
            }
            container.innerHTML = msg;
            return;
        }

        // Check for Hybrid Route (Car segments)
        let hasCar = false;
        data.itinerary.forEach(leg => {
            const flight = leg.flight || {};
            if (flight.airline && (flight.airline.includes('Carro') || flight.airline.includes('Aluguel'))) {
                hasCar = true;
            }
        });

        // Hybrid Alert
        let hybridAlert = '';
        if (hasCar) {
            hybridAlert = `<div class="alert alert-success mb-3">
                <div class="d-flex align-items-center">
                    <span class="fs-4 me-2">üöó</span>
                    <div>
                        <strong>Roteiro H√≠brido Detectado!</strong><br>
                        Como o destino n√£o possui aeroporto pr√≥ximo, inclu√≠mos um trecho terrestre recomendado.
                    </div>
                </div>
            </div>`;
        }

        // Summary Card
        const flightCost = (data.cost_breakdown && data.cost_breakdown.flight) || 0;
        const carCost = (data.cost_breakdown && data.cost_breakdown.car) || 0;

        const summary = `
            ${hybridAlert}
            <div class="card mb-4 border-success">
                <div class="card-body">
                    <div class="row text-center align-items-center">
                        <div class="col">
                            <h3 class="text-success">R$ ${data.total_cost.toFixed(2)}</h3>
                            <small class="text-muted">Custo Total Estimado</small>
                            ${hasCar ? '<div class="mt-2"><span class="badge bg-success">üöó Rota H√≠brida</span></div>' : ''}
                        </div>
                        <div class="col border-start border-end">
                            <ul class="list-unstyled text-start d-inline-block small mb-0">
                                <li>‚úàÔ∏è A√©reo: R$ ${flightCost.toFixed(2)}</li>
                                <li>üöó Carro: R$ ${carCost.toFixed(2)}</li>
                            </ul>
                        </div>
                        <div class="col">
                            <h3>${(data.total_duration / 60).toFixed(1)}h</h3>
                            <small>Tempo Total</small>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Itinerary Table
        let rows = '';

        // Format Helper
        const fmtTime = (isoStr) => {
            if (!isoStr) return 'N/A';
            const d = new Date(isoStr);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) +
                ` <small class="text-muted">${d.getDate()}/${d.getMonth() + 1}</small>`;
        };
        const mapSegments = [];

        data.itinerary.forEach(leg => {
            const flight = leg.flight || {};
            const isCar = flight.airline && (flight.airline.includes('Carro') || flight.airline.includes('Aluguel'));

            const rowClass = isCar ? 'table-success' : '';
            const icon = isCar ? 'üöó' : '‚úàÔ∏è';
            // Show Flight Number if valid
            let flightNumDisplay = '';
            if (flight.flight_number && flight.flight_number !== 'N/A') {
                flightNumDisplay = `<br><small class="text-muted">${flight.flight_number}</small>`;
            }
            const airlineDisplay = isCar ? `<strong>${flight.airline}</strong>` : (flight.airline || 'N/A') + flightNumDisplay;

            const depTime = fmtTime(flight.departure_time);
            const arrTime = fmtTime(flight.arrival_time);

            rows += `
                <tr class="${rowClass}" style="cursor: pointer;" onclick="showAlternatives('${leg.origin}-${leg.destination}')" title="Clique para ver alternativas">
                    <td><strong>${leg.origin}</strong> <br> <small class="text-muted">‚ûù ${leg.destination}</small></td>
                    <td>${icon} ${airlineDisplay}</td>
                    <td>${depTime}</td>
                    <td>${arrTime}</td>
                    <td>${leg.duration} min</td>
                    <td>R$ ${leg.price.toFixed(2)}</td>
                    <td><span class="badge bg-secondary">${flight.stops || 0} paradas</span></td>
                </tr>
            `;

            // Collect backend coords
            if (leg.origin_coords && leg.dest_coords) {
                mapSegments.push({
                    from_name: leg.origin,
                    to_name: leg.destination,
                    from: leg.origin_coords,
                    to: leg.dest_coords,
                    airline: flight.airline || 'N/A',
                    dep: depTime,
                    arr: arrTime
                });
            }

            // Collect backend coords (Duplicate removed)
        });

        const table = `
            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="resultTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="itinerary-tab" data-bs-toggle="tab" data-bs-target="#itinerary-content" type="button" role="tab">üìÖ Itiner√°rio Final</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alternatives-tab" data-bs-toggle="tab" data-bs-target="#alternatives-content" type="button" role="tab">üîç Outras Op√ß√µes Consultadas</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hotels-tab" data-bs-toggle="tab" data-bs-target="#hotels-content" type="button" role="tab">üè® Hot√©is Encontrados</button>
                </li>
            </ul>

            <div class="tab-content" id="resultTabContent">
                <!-- Itinerary Tab -->
                <div class="tab-pane fade show active" id="itinerary-content" role="tabpanel">
                    <div class="card shadow-sm mb-4">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Rota</th>
                                        <th>Cia A√©rea</th>
                                        <th>Partida</th>
                                        <th>Chegada</th>
                                        <th>Dura√ß√£o</th>
                                        <th>Pre√ßo</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Alternatives Tab -->
                <div class="tab-pane fade" id="alternatives-content" role="tabpanel">
                     <div id="alternativesContainer">
                        <p class="text-muted text-center p-3">Selecione uma rota para ver alternativas.</p>
                     </div>
                </div>

                <!-- Hotels Tab -->
                <div class="tab-pane fade" id="hotels-content" role="tabpanel">
                     <div id="hotelsContainer">
                        <p class="text-muted text-center p-3">Nenhum hotel buscado.</p>
                     </div>
                </div>
            </div>
        `;

        // Map Container
        const mapHtml = `
            <div class="card shadow-sm">
                <div class="card-header bg-white"><h5>üó∫Ô∏è Visualiza√ß√£o no Mapa</h5></div>
                <div class="card-body p-0">
                    <div id="map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        `;

        container.innerHTML = summary + table + mapHtml;

        // Render Alternatives
        renderAlternatives(data.alternatives);

        // Render Hotels
        renderHotels(data.hotels_found);

        // Init Map
        initMap(mapSegments);
    }

    // Show itinerary detail in modal
    async function showItineraryModal(id) {
        const modalBody = document.getElementById('itineraryModalBody');
        modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';
        const modalEl = document.getElementById('itineraryModal');
        const bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();

        try {
            const res = await fetch(`/users/history/${id}`, {
                headers: { 'Authorization': 'Bearer ' + getCookie('access_token') }
            });
            if (!res.ok) {
                modalBody.innerHTML = `<div class="alert alert-danger">Falha ao carregar detalhamento: ${res.status} ${res.statusText}</div>`;
                return;
            }
            const data = await res.json();

            let html = `
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title">Resumo</h5>
                    <p><strong>Custo total:</strong> R$ ${data.total_cost.toFixed(2)}</p>
                    <p><strong>Tempo total:</strong> ${(data.total_duration/60).toFixed(1)}h</p>
                  </div>
                </div>
                <div class="card"><div class="card-body"><h5>Trechos</h5><div class="table-responsive"><table class="table"><thead><tr><th>Origem</th><th>Destino</th><th>Cia</th><th>Partida</th><th>Chegada</th><th>Pre√ßo</th></tr></thead><tbody>`;

            data.itinerary.forEach(leg => {
                const f = leg.flight || {};
                const dep = f.departure_time ? new Date(f.departure_time).toLocaleString() : '-';
                const arr = f.arrival_time ? new Date(f.arrival_time).toLocaleString() : '-';
                html += `<tr>
                    <td>${leg.origin}</td>
                    <td>${leg.destination}</td>
                    <td>${f.airline || 'N/A'}</td>
                    <td>${dep}</td>
                    <td>${arr}</td>
                    <td>R$ ${leg.price.toFixed(2)}</td>
                  </tr>`;
            });

            html += '</tbody></table></div></div></div>';
            modalBody.innerHTML = html;
        } catch (e) {
            console.error(e);
            modalBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhamento.</div>`;
        }
    }

    function renderHotels(hotels) {
        const container = document.getElementById('hotelsContainer');
        if (!hotels || hotels.length === 0) {
            container.innerHTML = '<p class="text-muted text-center p-3">Nenhum hotel encontrado.</p>';
            return;
        }

        let html = '<div class="row row-cols-1 row-cols-md-2 g-4">';
        hotels.forEach(h => {
            html += `
                <div class="col">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title text-primary">${h.name}</h5>
                                <span class="badge bg-success ms-2">‚≠ê ${h.rating}</span>
                            </div>
                            <h6 class="card-subtitle mb-2 text-muted">üìç ${h.city}</h6>
                            <hr>
                            <p class="card-text fs-4 fw-bold">R$ ${h.price_per_night.toFixed(2)} <span class="fs-6 text-muted fw-normal">/ noite</span></p>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    // Map Logic (Leaflet)
    function initMap(segments) {
        if (typeof L === 'undefined') return;
        if (!segments || segments.length === 0) return;

        // Reset Map if exists
        if (window.currentMap) {
            window.currentMap.remove();
            window.currentMap = null;
        }

        const map = L.map('map');
        window.currentMap = map;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        const allPoints = [];

        segments.forEach(seg => {
            // Markers
            L.marker(seg.from).addTo(map).bindPopup(`<b>${seg.from_name}</b>`);
            L.marker(seg.to).addTo(map).bindPopup(`<b>${seg.to_name}</b>`);

            // Path
            const latlngs = [seg.from, seg.to];

            // Check if it's a car segment
            const isCar = seg.airline && (seg.airline.includes("Carro") || seg.airline.includes("Aluguel"));

            const polyOptions = {
                color: isCar ? '#28a745' : '#dc3545',
                weight: 4,
                opacity: 0.7,
                dashArray: isCar ? '10, 10' : null
            };

            const poly = L.polyline(latlngs, polyOptions).addTo(map);

            // Detailed Popup
            let content = `<b>${seg.from_name} ‚ûù ${seg.to_name}</b><br>${seg.airline}`;
            if (seg.dep && seg.arr) {
                content += `<hr class="my-1">üõ´ Partida: ${seg.dep}<br>üõ¨ Chegada: ${seg.arr}`;
            }
            poly.bindPopup(content);

            allPoints.push(seg.from);
            allPoints.push(seg.to);
        });

        if (allPoints.length > 0) {
            map.fitBounds(allPoints, { padding: [50, 50] });
        }
    }

    // Capture Alternatives Data
    let globalAlternatives = {};

    function renderAlternatives(alternatives) {
        globalAlternatives = alternatives || {};
        const container = document.getElementById('alternativesContainer');
        container.innerHTML = '';

        if (Object.keys(globalAlternatives).length === 0) {
            container.innerHTML = '<p class="text-muted text-center p-3">Nenhuma alternativa encontrada.</p>';
            return;
        }

        let html = '<div class="accordion" id="accordionAlternatives">';

        Object.keys(globalAlternatives).forEach((key, index) => {
            const flights = globalAlternatives[key];
            const collapseId = `collapse-${index}`;
            const headingId = `heading-${index}`;

            // Extract Origin/Dest from key (e.g. "S√£o Paulo-Miami")
            const [origin, dest] = key.split('-');

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headingId}">
                        <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${index === 0}" aria-controls="${collapseId}">
                            ‚úàÔ∏è Op√ß√µes: ${origin} ‚ûù ${dest} (${flights.length})
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="${headingId}" data-bs-parent="#accordionAlternatives">
                        <div class="accordion-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Cia A√©rea</th>
                                            <th>Voo</th>
                                            <th>Partida</th>
                                            <th>Chegada</th>
                                            <th>Dura√ß√£o</th>
                                            <th>Pre√ßo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;

            flights.forEach(f => {
                const dep = new Date(f.departure_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const arr = new Date(f.arrival_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                html += `
                    <tr>
                        <td>${f.airline}</td>
                        <td>${f.flight_number || '-'}</td>
                        <td>${dep}</td>
                        <td>${arr}</td>
                        <td>${f.duration_minutes} min</td>
                        <td class="fw-bold">R$ ${f.price.toFixed(2)}</td>
                    </tr>
                 `;
            });

            html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    // Deprecated click handler, but nice to keep if we want to auto-open specific accordion
    window.showAlternatives = function (key) {
        // Switch tab
        const tabTrigger = new bootstrap.Tab(document.querySelector('#alternatives-tab'));
        tabTrigger.show();

        // Find accordion item matching key?
        // Key is "Origin-Dest". Logic above creates keys in undefined order, but we can match text content or ID if we made it predictable.
        // For now, simply switching tab is enough since all are listed.
    };
</script>
<!-- Load Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}