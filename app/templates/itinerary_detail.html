{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <h2>Detalhes do Itinerário</h2>
      <div id="itineraryDetail" class="mt-3">
        <p class="text-muted">Carregando...</p>
      </div>
      <div class="mt-3">
        <a href="/" class="btn btn-secondary">← Voltar</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function getCookie(name) {
      let value = "; " + document.cookie;
      let parts = value.split("; " + name + "=");
      if (parts.length == 2) return parts.pop().split(";").shift();
  }

  (async function loadDetail() {
    const id = {{ itinerary_id }};
    const container = document.getElementById('itineraryDetail');
    try {
      const res = await fetch(`/api/itineraries/${id}`, {
        headers: { 'Authorization': 'Bearer ' + getCookie('access_token'), 'Content-Type': 'application/json' }
      });
      if (!res.ok) {
        container.innerHTML = `<div class="alert alert-danger">Falha ao carregar detalhamento: ${res.status} ${res.statusText}</div>`;
        return;
      }
      const data = await res.json();
      if (!data || !data.itinerary) {
        container.innerHTML = '<p class="text-muted">Nenhum detalhe disponível.</p>';
        return;
      }

      // Render a simple details view
      let html = `
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h5 class="card-title">Resumo</h5>
            <p><strong>Custo total:</strong> R$ ${data.total_cost.toFixed(2)}</p>
            <p><strong>Tempo total:</strong> ${(data.total_duration/60).toFixed(1)}h</p>
          </div>
        </div>
      `;

      html += '<div class="card"><div class="card-body"><h5>Trechos</h5><div class="table-responsive"><table class="table"><thead><tr><th>Origem</th><th>Destino</th><th>Cia</th><th>Partida</th><th>Chegada</th><th>Preço</th></tr></thead><tbody>';

      data.itinerary.forEach(leg => {
        const f = leg.flight || {};
        const dep = f.departure_time ? new Date(f.departure_time).toLocaleString() : '-';
        const arr = f.arrival_time ? new Date(f.arrival_time).toLocaleString() : '-';
        html += `<tr>
            <td>${leg.origin}</td>
            <td>${leg.destination}</td>
            <td>${f.airline || 'N/A'}</td>
            <td>${dep}</td>
            <td>${arr}</td>
            <td>R$ ${leg.price.toFixed(2)}</td>
          </tr>`;
      });

      html += '</tbody></table></div></div></div>';

      container.innerHTML = html;

    } catch (e) {
      console.error(e);
      container.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhamento.</div>`;
    }
  })();
</script>
{% endblock %}
